{% extends "uxbase.html" %}

{% block title %}Consult{% endblock %}
{% block head %}
{{ super() }}



<script>

  const jsonUserData = {{ user_records | tojson }};
  const record_kind = parseInt("{{ record_kind }}");
  var client_nprofile = "{{client_nprofile}}";

  const ws = new WebSocket("wss://{{request.url.hostname}}/safebox/wsrequesttransmittal");

  ws.onopen = () => console.log("WebSocket connected");
  ws.onmessage = (event) => {
    console.log("Message received:", event.data);
    const response = JSON.parse(event.data);  
    client_nprofile = response.nprofile;
    alert(`Client is authenticated! Ready to transmit files`);




};
ws.onclose = () => console.log("WebSocket closed");

</script>

<script>

var global_naddr = "";

async function backToProfile() {


window.location.href="/safebox/access" ;

}

async function scanCode() {
// alert("scan!");

window.location.href="/scanner/scan";

}

async function getQRStatus(return_result) {

var qr_img_func = document.getElementById("img_qr_display");

parsedResult = JSON.parse(JSON.stringify(return_result));

 global_naddr = parsedResult.detail;

qr_img_func.src = "/safebox/qr/"+ global_naddr;
// qr_img_func.addEventListener("click", copytoClipboard);



}

async function createQRCode() {
    
    var data;
  

   await fetch('/safebox/naddr', {
        method: "GET",
        headers: {"Content-Type": "application/json"}        
              
       })
    .then((response) => response.json())
    .then((data) => getQRStatus(data));


}


</script>

{% endblock %}

{% block page_content %}



<div class="center-text">
    <h1>Health Consultation</h1>
    <button id="ln_scan_button" onclick="scanCode()">Scan Recipient</button>
    <br><br>
    <button onclick="addCardtoSafebox()">Add Record</button>

   
    
</div>

<div id="card-container"></div>

<script>


  // Function to create and add a card
  function addCard(title, created_at, content) {
    // Create a card element
    const card = document.createElement('div');
    card.className = 'card';

    // Create and add the title element
    const cardTitle = document.createElement('div');
    cardTitle.className = 'card-title';
    cardTitle.textContent = title;

    // Create and add the created_at element
    const cardCreatedAt = document.createElement('div');
    cardCreatedAt.className = 'card-content';
    cardCreatedAt.textContent = `${created_at}`;

    // Create and add the content element
    const cardContent = document.createElement('div');
    cardContent.className = 'card-content';
    cardContent.textContent = content;

    // Append title and content to the card
    card.appendChild(cardTitle);
    card.appendChild(cardCreatedAt);
    card.appendChild(cardContent);

    card.addEventListener('click', () => {
        // alert(`You clicked on: ${title} with: ${content}`);
        window.location.href=`/safebox/displaycard?card=${title}&action_mode=edit&kind={{record_kind}}`;
      });

    // Append the card to the container
    const container = document.getElementById('card-container');
    container.appendChild(card);
  }

  // Example usage
  // alert("hello"+ JSON.stringify(jsonUserData)); 
  for (let record of jsonUserData)
  {
    if (record.hasOwnProperty("tag")) {
        // console.log(`Name: ${record.name}`);
        addCard(record.tag, record.created_at,record.payload);
    } else {
        console.log("This record does not have a 'name' property.");
    }
    // addCard('Private Data 1', JSON.stringify(record));

  }

async function addCardtoSafebox() {
// alert(`add card ${record_kind}`);
window.location.href=`/safebox/displaycard?action_mode=add&kind=${record_kind}`;


}

async function getStatus(return_result) {


parsedResult = JSON.parse(JSON.stringify(return_result));
alert(`${parsedResult.status} ${parsedResult.detail}`);

 

}

async function transmitToNprofile() {

    if (client_nprofile=="None") {
      alert(`Please scan client QR Code!`);
      return;
    }

    if (confirm(`Are you sure you want to send to: ${client_nprofile}?`)) {
      // alert(`Sending...`);
    } else {return;}
  
    var data;
   


  const submit_data = {"nprofile": client_nprofile, "kind":32227 };

   

  await fetch('/safebox/transmit', {
       method: "POST",
       headers: {"Content-Type": "application/json"},        
       body: JSON.stringify(submit_data)         
      })
   .then((response) => response.json())
   .then((data) => getStatus(data));

   // window.location.href=referer;
     }




setDarkMode();


</script>
   

<div class="center-text">
      
  <button onclick="transmitToNprofile()">Transmit Records</button>   

  <br><br>
  <button onclick="backToProfile()">Home</button>
  <br>
 <h2>Client Scan</h2>
    
 <img id="img_qr_display" onclick="createQRCode()"  src="/img/logo.png" >
<br><br>
{% if client_nprofile %}
{{client_nprofile[:20] }}...{{ client_nprofile[-15:]}} 
{% endif %}    
     
        
</div>
     



{% endblock %}

{% block scripts %}
{{ super() }}


{% endblock %}